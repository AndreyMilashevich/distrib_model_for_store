# distrib_model_for_store

# Алгоритм упаковки товаров в коробки

Автоматизированный скрипт на Python для оптимальной упаковки товаров в коробки на основе статистики совместных покупок, габаритов и совместимости категорий.

---

## Цель проекта

Оптимизировать процесс упаковки товаров в коробки для логистики или сборки заказов, учитывая:

- Частоту совместных покупок (ко-заказы)
- Габариты и объёмы товаров
- Совместимость категорий товаров
- Ограничения по объёму коробки и количеству товаров в ней

---

## Основные функции

### 1. `n_orders_weight_matrix(df)`
Строит **нормализованную матрицу совместной встречаемости** товаров в заказах.  
На выходе — DataFrame, где ячейка `[i, j]` показывает, как часто товар `i` покупают вместе с товаром `j`, нормализовано на общее число заказов и умножено на 10000.

> Матрица сортируется по убыванию суммы по столбцам — самые популярные товары в начале.

---

### 2. `clear_df(df, matrix, max_height=30, fullness=0.85)`
Очищает исходный датасет от:

- **Топ-288 самых частых товаров** (типа "А" — часто встречаются, упаковываются отдельно)
- **Замороженных продуктов, овощей/фруктов, орехов**
- **Крупногабаритных товаров** (высота > `max_height * fullness`)

---

### 3. `box_distrib(df, matrix, compatibility_matrix, box_volume, res_volume=0.08, max_num_items=6)`
Алгоритм упаковки:

1. Берёт самый популярный товар из оставшихся.
2. Подбирает к нему совместимые товары, максимизируя совместную встречаемость и минимизируя объём.
3. Учитывает:
   - Совместимость категорий (по внешней матрице)
   - Ограничение по объёму коробки (`box_volume`)
   - Резервный объём (`res_volume`)
   - Максимальное количество товаров в коробке (`max_num_items`)
4. Формирует пары: `основной товар → соседний товар` с метрикой совместимости.
5. Выделяет **одиночные товары**, которые не поместились ни в одну коробку.

Возвращает:
- DataFrame с парами упакованных товаров
- Остаток неупакованных товаров
- Список одиночных товаров

---

## Входные данные

Скрипт ожидает **JSON-файл с параметрами**, например:

```json
{
  "sales_path": "путь/к/продажам.csv",
  "dim_path": "путь/к/габаритам.csv",
  "compatibility_path": "путь/к/совместимости.csv",
  "height": 60,
  "width": 40,
  "depth": 30,
  "fullness": 0.85,
  "reserv_volume": 0.08,
  "max_plu_number": 6
}
```

### 1. Продажи (`sales_path`)
Должен содержать колонки:
- `order_id` — идентификатор заказа
- `plu_id` — идентификатор товара

### 2. Габариты (`dim_path`)
Обязательные колонки:
- `plu_id`
- `plu_height_amt`, `plu_width_amt`, `plu_depth_amt` — габариты товара (в мм или других единых единицах)
- `Квант` — количество единиц товара в упаковке (по умолчанию = 1, если отсутствует)

Скрипт автоматически рассчитывает объём товара:  
`volume = plu_height_amt × plu_width_amt × plu_depth_amt × Квант`

> Все размеры должны быть числовыми. Неполные данные заполняются по умолчанию.

### 3. Совместимость категорий (`compatibility_path`)
- Разделитель: `;`
- Кодировка: `cp1251` (Windows-1251)
- Обязательные колонки:
  - `Категория_1` — название первой категории
  - `Категория_2` — название второй категории
  - `Совместимость` — числовой флаг:
    - `1` — можно упаковывать вместе
    - `≠1` — **нельзя** упаковывать вместе

> Если пара категорий отсутствует в файле — считается, что они совместимы.

---

## Выходные файлы

После выполнения создаются:

### 1. `результат_упаковки.csv`
Список пар товаров, упакованных вместе:

| Поле               | Описание                                     |
|--------------------|----------------------------------------------|
| `main_item`        | ID основного товара                          |
| `main_item_volume` | Объём основного товара                       |
| `neighbor_item`    | ID соседнего товара                          |
| `neighbor_volume`  | Объём соседнего товара                       |
| `concurrence`      | Метрика совместной встречаемости (взвешенная)|

### 2. `товары_одиночки.csv`
Товары, которые не удалось упаковать с другими:

| Поле      | Описание            |
|-----------|---------------------|
| `plu_id`  | ID товара           |
| `volume`  | Объём товара        |

> Оба файла сохраняются в кодировке `utf-8-sig` для корректного открытия в Excel.

---

## Как запустить
Запускается из файла distrib_model.exe в директории dist

Используется разреженная матрица (scipy.sparse.csr_matrix) для эффективного подсчёта совместных покупок.
Совместимость категорий проверяется строго — если пара категорий отсутствует в матрице, считается совместимой (is_compatible = 1).
Одиночные товары выносятся в отдельный файл для ручной обработки.
Алгоритм жадный — не гарантирует глобально оптимальную упаковку, но работает быстро и эффективно на практике.
